# Evmos - Keplr Signing Issues

## Authors

* Austin Chandra (evmos.org)
* Adit Gupta (evmos.org)
* Akash Khosla (evmos.org)

### Date

2022-03-10

## Brief Overview

- Users were unable to send tokens, delegate, or vote on governance using Keplr. Any attempt to do so triggered a variant of the following error messages: "*pubKey does not match signer address*" and "*signature verification failed*"
- Many users resorted to using community-built alternatives (namely [Disperze](https://evmos.disperze.network/) and [Evmos.me](https://evmos.me)) to claim their airdrops and start staking their tokens
- While these websites served as an appropriate temporary substitute for Keplr, launching without official wallet support increased the risk assumed by the community and created difficulties in claiming and staking tokens
- Ledger users signing into Keplr derived and displayed the wrong public key, so attempts to send funds to the Ledger accounts resulted in stuck funds

## Timeline

> *NOTE*: All times in UTC


### March 3rd, 2022

*03:21* - Evmos team encounters and flags a public key bug preventing Keplr from signing Evmos transactions.

*06:17* - Fix for Keplr public key bug is completed 

*06:17* - Evmos team identifies another bug after correcting the public key bug and begins debugging Keplr signature verification bug 

*20:05* - Evmos team discovers that Keplr is displaying incorrect public keys for users signed in with Ledger

### March 4th, 2022

*00:57* - Evmos team discusses whether to temporarily pull Keplr support to avoid community confusion and potential loss of funds

*01:49* - Following dicussions, team decides to keep current Keplr release as community platforms such as Disperze offered limited Keplr functionality. Pulling the release would result in an abrupt service interruption and contribute to further confusion within the community.

*21:10* - Evmos team is still unable to isolate the Keplr signature verification bug

### March 5th, 2022

*06:08* - Evmos team identifies short-term solution to Keplr signature verification in changing Evmos node service provider's configuration

*06:14* - Evmos team engages in discussions with aforementioned node service provider

*06:32* - Fix for Keplr public key bug is [pushed](https://github.com/chainapsis/keplr-wallet/pull/313#issue-1160260958) 

*07:20* - Fix for Keplr public key bug is merged into Keplr

*07:21* - Fix for Keplr signature verification bug, which was via altering the gas config is [merged](https://github.com/chainapsis/keplr-wallet/pull/308) into Keplr

*07:50* - New Keplr build released with public key bug fix and signature verification fix

*19:06* - Node service provider updates their configuration to match Evmos provided specification


## Five Whys

> Use the [root cause identification technique](https://en.wikipedia.org/wiki/Five_whys). Start with the impact and ask why it happened and why it have the impact it did. Continue asking why until you arrive at the root cause. Document your "whys" as a list here or in a diagram attached to the issue.

### Problem: Users could not send tokens, delegate, or vote on governance within Keplr

**Why were users unable to perform these core actions?**
1. The public key type generated by Keplr did not match the expected public key type
2. The payload verification failed upon reaching the Evmos mainnet nodes (meaning the signature didn't match up)

---

**Why did the public key type generated by Keplr not match the expected public key type?**

* Keplr was returning the default `cosmos.crypto.secp256k1` key type rather than the expected `ethermint.crypto.v1.ethsecp256k1` keytype

**Why was Keplr returning the Cosmos keytype rather than the Ethermint keytype?**

* The `coinType` was not being fetched properly, so attempts to see whether we were on an Ethereum-based chain by checking `coinType = 60` were unsuccessful


**Why was Keplr unable to fetch the `coinType`?**

* The Keplr config for the Evmos (Beta) mainnet chain had a different structure from the Keplr config for the Evmos testnet. Our signing code relied on the config matching that used by the testnet.
    ```
    // Testnet Configuration
    {
      bip44: {
        coinType: 60,  
      },
      coinType: 60,
      ...
    }
    ```
    
    ```
    // Mainnet Configuration
    {
      bip44: {
        coinType: 60,  
      },
      ...
    }
    ```

**Why did Keplr have a different config in Mainnet?**

* Evmos team modelled the final mainnet config off of the mainnet configs by other chains, not off of the Evmos testnet config, and thus correctly did not include the extraneous `coinType` field
* Evmos team did not, however, test for differences between the testnet and mainnet configs, and thus was not aware of the `coinType` issue

**Why was Keplr able to approve signs generated by Evmos.me and Disperze, but not core actions performed within Keplr?**

* Evmos.me and Disperze used Keplr's `signDirect` endpoint, an offline signer, to generate the signature payload, which they manually broadcasted to an Evmos node
* This was successful because Keplr's offline signer worked without issue, and by broadcasting the signature and payload outside of Keplr, the dashboards avoided both the `coinType` and gas-related issues

---

**Why did signature payload verification fail upon reaching the Evmos mainnet nodes?**

* The deployed mainnet nodes responded with a gas-related error

**Why did the deployed mainnet nodes respond with a gas-related error?**

* The deployed mainnet nodes had set the `minimum-gas-prices = 0.25aevmos`, but Keplr was sending insufficient gas for the transactions

**Why was Keplr sending insufficient gas for the transactions?**

* Evmos's mainnet config within Keplr set the minimum gas levels to the following:

```
gasPriceStep: {
  low: 0.005,
  average: 0.025,
  high: 0.04,
},
```
* Since Evmos recognizes denomations to 18 decimal places (compared to 6 decimal places for Cosmos chains), after being scaled, these gas values became 12 orders of magnitude smaller than expected

**Why couldn't users manually increase the gas to compensate for this?**

* There is a distinction between the fee amount and the gas, and both values are sent separately. While users can adjust the gas, the fee amount is determined by the config, and the Evmos nodes expected a range of values for the fee amount that was not satisfied

**Why did Keplr's configuration contain incorrect fee amounts?**

* In testing, Evmos's testnet node had a `minimum_gas_fee = 0aevmos`, so although the Keplr config still used a low gas step price, the issue was never enforced by the  node
* Evmos team reused this Keplr configuration in mainnet, in addition to updating the `minimum_gas_fee` to `0.25aevmos`, without realizing this could cause an issue



## Remediation

### Upstream Changes in Keplr
* [x] Properly derive `coinType` given mainnet configuration ([PR - Merged](https://github.com/chainapsis/keplr-wallet/pull/313))

### Update Keplr Configuration
* [x] Update gas price step configuration to correct values ([PR by Community Member - Merged](https://github.com/chainapsis/keplr-wallet/pull/308/files))

### Update Mainnet Configuration
* [x] Set the minimum mainnet gas price to `0aevmos` as a temporary workaround solution

### Engineering
* [ ] Create documentation regarding configuration variables across the project
* [x] Post Mortem document of the incident and remediations
* [x] Bring up extra `coinType` field in Keplr config to Keplr team's attention, as it ended up being a footgun and is redundant ([copy-paste example](https://keplr.crunch.help/integrating-your-chain/how-to-suggest-a-chain))
* [ ] Construct a QA guide for Keplr (based on the ones we already have) to include a mainnet config modification step so that we're using the mainnet config but with correct RPCs
